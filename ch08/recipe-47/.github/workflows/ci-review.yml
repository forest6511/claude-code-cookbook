name: AI Code Review
on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code
      - name: Run Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          claude -p "/ci-review" \
            --output-format json \
            --max-turns 10 \
            --dangerously-skip-permissions \
            > review.json
      - name: Check Results
        run: |
          HIGH=$(jq '[.result.issues[]
            | select(.severity == "HIGH")]
            | length' review.json)
          if [ "$HIGH" -gt 0 ]; then
            echo "::error::$HIGH high issues"
            exit 1
          fi
